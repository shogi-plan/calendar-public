<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>é ã‚¿ãƒ¡å¤§ä¼š</title>
  <style>
    body { font-family: "Yu Gothic", sans-serif; margin: 10px; background: #f0f0f0; }
    h1, h2 { text-align: center; color: #5d4037; margin-bottom: 10px; }
    .container { max-width: 850px; margin: 0 auto 20px; background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    input[type="text"], select { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
    
    .note-label { display: block; color: #d32f2f; font-size: 0.85rem; font-weight: bold; margin-bottom: 8px; }
    .title-note-wrapper { max-width: 850px; margin: 0 auto 10px; }

    /* ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚¨ãƒªã‚¢ */
    .filter-area { margin-bottom: 15px; padding: 10px; background: #fff9c4; border-radius: 4px; border: 1px solid #fbc02d; }
    .filter-label { font-size: 0.9rem; font-weight: bold; color: #5d4037; margin-bottom: 5px; display: block; }

    /* ãƒãƒ£ãƒƒãƒˆ */
    #chatMessages { height: 150px; margin-bottom: 10px; padding: 10px; background: #fafafa; border: 1px solid #eee; overflow-y: auto; font-size: 0.95rem; }
    #chatMessages a { color: #1976d2; text-decoration: underline; }
    .chat-input-area { display: flex; gap: 5px; }
    button { padding: 8px 12px; border: none; border-radius: 4px; cursor: pointer; color: white; font-weight: bold; }
    #sendBtn { background-color: #795548; }
    #chatClearBtn { background-color: #9e9e9e; }
    
    /* ãƒªãƒ¼ã‚°çµæœè¡¨ */
    .matrix-wrapper { overflow-x: auto; border: 1px solid #d7ccc8; }
    .matrix-table { border-collapse: collapse; font-size: 0.85rem; background: #fff; min-width: 100%; }
    .matrix-table th, .matrix-table td { border: 1px solid #d7ccc8; padding: 10px; text-align: center; white-space: nowrap; }
    .matrix-table th { background-color: #8d6e63; color: white; }
    .row-label { background-color: #8d6e63 !important; color: white !important; font-weight: bold; }
    .matrix-diagonal { background-color: #e0e0e0; }
    .win-text { color: #d32f2f; font-weight: bold; }
    .lose-text { color: #1976d2; font-weight: bold; }
    .draw-text { color: #757575; font-weight: bold; }

    /* å¯¾å±€ä¸€è¦§ */
    .shogi-table { width: 100%; border-collapse: collapse; margin-top: 10px; table-layout: fixed; }
    .shogi-table th, .shogi-table td { border: 1px solid #d7ccc8; padding: 4px; text-align: center; vertical-align: middle; }
    .shogi-table th { background-color: #a1887f; color: white; font-size: 0.8rem; white-space: nowrap; }
    
    .game-link { color: #1976d2; text-decoration: underline; font-weight: bold; }
    .col-check { width: 35px; }
    .col-no { width: 35px; }
    .col-result { width: 75px; }
    .col-player { width: auto; }

    .add-row-btn { background-color: #5d4037; width: 100%; margin-top: 10px; }
    .list-del-btn { background-color: #f44336; width: 100%; margin-top: 10px; }
    .lock-btn { background-color: #ff9800; width: 100%; margin-top: 10px; }
    
    .admin-only { display: none; }
    .master-delete-area { max-width: 850px; margin: 40px auto; text-align: center; border-top: 2px dashed #ccc; padding-top: 20px; }
    #masterDeleteBtn { background-color: #d32f2f; width: 100%; padding: 15px; font-size: 1rem; }
  </style>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getDatabase, ref, remove, update, onValue, push, get } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

    const GAME_BASE_URL = "https://shogi-plan.github.io/calendar-public/room"; 

    const firebaseConfig = {
      apiKey: "AIzaSyCx5anv3WWOQyke9kqhhZ9Zx-RjynLuxzE",
      authDomain: "calendar-chousei.firebaseapp.com",
      databaseURL: "https://calendar-chousei-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "calendar-chousei",
      storageBucket: "calendar-chousei.firebasestorage.app",
      messagingSenderId: "368704703397",
      appId: "1:368704703397:web:86ae24d920aaf7c5a0f64c"
  };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const roomName = location.pathname.split('/').pop().replace('.html', '');

    const urlParams = new URLSearchParams(window.location.search);
    const isAdmin = urlParams.get('admin') === 'true';

    // æœ€å¾Œã«å–å¾—ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒï¼ˆãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ™‚ã«å†æç”»ã™ã‚‹ãŸã‚ï¼‰
    let lastSnapshotData = null;

    function escapeHtml(str) {
      const div = document.createElement('div');
      div.textContent = str || "";
      return div.innerHTML;
    }

    function linkify(text) {
      const urlPattern = /(https?:\/\/[\w\/:%#\$&\?\(\)~\.=\+\-]+)/g;
      return text.replace(urlPattern, '<a href="$1" target="_blank" rel="noopener noreferrer">$1</a>');
    }

    // å†æç”»ç”¨ãƒ¡ã‚¤ãƒ³é–¢æ•°
    function renderContent() {
      if (!lastSnapshotData) return;
      const data = lastSnapshotData;
      const playerMaster = data.playerMaster || {};
      const shogiGames = data.shogiGames || {};

      // 1. åç°¿ã¨ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã®é¸æŠè‚¢ã‚’æ›´æ–°ï¼ˆãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãŒæœªé¸æŠã®å ´åˆã®ã¿ï¼‰
      const playerFilter = document.getElementById("playerFilter");
      const filterValue = playerFilter.value; // ç¾åœ¨ã®é¸æŠã‚’ä¿å­˜
      
      const currentPlayers = [];
      const playerListBody = document.getElementById("playerListBody");
      playerListBody.innerHTML = "";
      
      // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã®ãƒªã‚»ãƒƒãƒˆç”¨ä»¥å¤–ã®é¸æŠè‚¢ã‚’ä¸€æ—¦ã‚¯ãƒªã‚¢
      const filterOptions = ['<option value="">-- ã™ã¹ã¦ã®å¯¾å±€ã‚’è¡¨ç¤º --</option>'];
      
      let pIdx = 1;
      Object.keys(playerMaster).forEach(id => {
        const name = playerMaster[id].name || "";
        if (name) {
          currentPlayers.push(name);
          filterOptions.push(`<option value="${escapeHtml(name)}">${escapeHtml(name)}</option>`);
        }
        playerListBody.innerHTML += `<tr>
          <td class="admin-only" style="${isAdmin ? 'display:table-cell' : 'display:none'}"><input type="checkbox" class="master-del-check" value="${id}"></td>
          <td>${pIdx++}</td>
          <td><input type="text" value="${escapeHtml(name)}" onchange="updateMaster('${id}', this.value)"></td>
        </tr>`;
      });
      currentPlayers.sort();

      // ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã®æ›´æ–°ï¼ˆé¸æŠçŠ¶æ…‹ã‚’ç¶­æŒã—ã¤ã¤ä¸­èº«ã‚’æ›´æ–°ï¼‰
      const tempValue = playerFilter.value;
      playerFilter.innerHTML = filterOptions.join("");
      playerFilter.value = tempValue;

      // 2. å¯¾å±€ä¸€è¦§ã®æç”»ï¼ˆãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨ï¼‰
      const shogiBody = document.getElementById("shogiBody");
      shogiBody.innerHTML = "";
      const games = [];
      let gIdx = 1;

      Object.keys(shogiGames).forEach(id => {
        const g = { id, no: gIdx++, ...shogiGames[id] };
        games.push(g);

        // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼åˆ¤å®š
        if (filterValue !== "" && g.p1 !== filterValue && g.p2 !== filterValue) {
          return; // ä¸€è‡´ã—ãªã„ãƒ¬ã‚³ãƒ¼ãƒ‰ã¯è¡¨ç¤ºã—ãªã„
        }

        const opts = (val) => `<option value="">-</option>` + currentPlayers.map(n => `<option value="${escapeHtml(n)}" ${val===n?'selected':''}>${escapeHtml(n)}</option>`).join("");
        const rowBgColor = (g.result && g.result !== "-") ? 'style="background-color: #a9a9a9;"' : "";
        const isLocked = g.isLocked === true;
        const gameUrl = GAME_BASE_URL + g.no;

        shogiBody.innerHTML += `<tr ${rowBgColor}>
          <td class="admin-only" style="${isAdmin ? 'display:table-cell' : 'display:none'}"><input type="checkbox" class="del-check" value="${id}"></td>
          <td class="col-no">
            ${isLocked ? '<span style="color:#ccc;">-</span>' : `<a href="${gameUrl}" target="_blank" rel="noopener noreferrer" class="game-link">${g.no}</a>`}
          </td>
          <td class="col-player"><select onchange="updateGame('${id}','p1',this.value)">${opts(g.p1)}</select></td>
          <td class="col-player"><select onchange="updateGame('${id}','p2',this.value)">${opts(g.p2)}</select></td>
          <td class="col-result"><select onchange="updateGame('${id}','result',this.value)">
            <option value="-" ${g.result==='-'?'selected':''}>-</option>
            <option value="â—‹" ${g.result==='â—‹'?'selected':''}>å…ˆå‹</option>
            <option value="Ã—" ${g.result==='Ã—'?'selected':''}>å¾Œå‹</option>
            <option value="â–³" ${g.result==='â–³'?'selected':''}>å¼•åˆ†</option>
          </select></td>
        </tr>`;
      });

      // 3. ãƒãƒˆãƒªã‚¯ã‚¹ï¼ˆæ˜Ÿå–è¡¨ï¼‰ã®æç”»
      renderMatrix(currentPlayers, games);
    }

    document.addEventListener("DOMContentLoaded", () => {
      if (isAdmin) {
        document.querySelectorAll('.admin-only').forEach(el => {
          el.style.display = (el.tagName === 'TH' || el.tagName === 'TD') ? 'table-cell' : 'block';
        });
      }

      // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼å¤‰æ›´æ™‚ã«å†æç”»
      document.getElementById("playerFilter").onchange = renderContent;

      onValue(ref(db, roomName), (snapshot) => {
        lastSnapshotData = snapshot.val() || {};
        renderContent();
      });

      // ãƒãƒ£ãƒƒãƒˆç”¨
      onValue(ref(db, `${roomName}/chat`), (s) => {
        const div = document.getElementById("chatMessages");
        div.innerHTML = "";
        s.forEach(c => { 
          const m = c.val(); 
          div.innerHTML += `<p style="margin:4px 0;"><strong>${escapeHtml(m.name)}</strong>: ${linkify(escapeHtml(m.text))}</p>`; 
        });
        div.scrollTop = div.scrollHeight;
      });

      // å„ç¨®æ›´æ–°é–¢æ•°ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«
      window.updateMaster = (id, name) => update(ref(db, `${roomName}/playerMaster/${id}`), { name });
      window.updateGame = (id, f, v) => update(ref(db, `${roomName}/shogiGames/${id}`), { [f]: v });

      // ä»¥ä¸‹ã€å„ç¨®ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆ
      document.getElementById("sendBtn").onclick = () => {
        const name = document.getElementById("nameInput").value.trim();
        const text = document.getElementById("chatInput").value.trim();
        if (name && text) push(ref(db, `${roomName}/chat`), { name, text, time: Date.now() });
        document.getElementById("chatInput").value = "";
      };
      document.getElementById("addRowBtn").onclick = () => push(ref(db, `${roomName}/shogiGames`), { p1: "", p2: "", result: "-", isLocked: false });
      document.getElementById("addPlayerBtn").onclick = () => push(ref(db, `${roomName}/playerMaster`), { name: "" });
      document.getElementById("listDelBtn").onclick = async () => {
        const c = document.querySelectorAll(".del-check:checked");
        if (c.length && confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) for (const x of c) await remove(ref(db, `${roomName}/shogiGames/${x.value}`));
      };
      document.getElementById("lockGameBtn").onclick = async () => {
        const c = document.querySelectorAll(".del-check:checked");
        if (!c.length) return alert("å¯¾å±€ã‚’é¸æŠã—ã¦ãã ã•ã„");
        for (const x of c) {
          const gRef = ref(db, `${roomName}/shogiGames/${x.value}`);
          const snap = await get(gRef);
          await update(gRef, { isLocked: !(snap.val().isLocked) });
        }
      };
    });

    function renderMatrix(players, games) {
      const head = document.getElementById("matrixHeader");
      const body = document.getElementById("matrixBody");
      head.innerHTML = "<tr><th></th>" + players.map(p => `<th>${escapeHtml(p)}</th>`).join("") + "</tr>";
      body.innerHTML = players.map(rowP => {
        let row = `<tr><td class="row-label">${escapeHtml(rowP)}</td>`;
        players.forEach(colP => {
          if (rowP === colP) row += `<td class="matrix-diagonal"></td>`;
          else {
            const m = games.filter(g => (g.p1===rowP && g.p2===colP) || (g.p1===colP && g.p2===rowP));
            const res = m.map(g => {
              if (!g.result || g.result === "-") return null;
              let sym = "", className = "";
              if (g.result === "â–³") { sym = "â–³"; className = "draw-text"; } 
              else if (g.p1 === rowP) { sym = (g.result === "â—‹") ? "â—‹" : "Ã—"; className = (sym === "â—‹") ? "win-text" : "lose-text"; } 
              else { sym = (g.result === "â—‹") ? "Ã—" : "â—‹"; className = (sym === "â—‹") ? "win-text" : "lose-text"; }
              return g.isLocked ? `<span class="${className}">${g.no}:${sym}</span>` : `<a href="${GAME_BASE_URL}${g.no}" target="_blank" class="${className}" style="text-decoration:none;">${g.no}:${sym}</a>`;
            }).filter(r=>r).join("ã€");
            row += `<td>${res}</td>`;
          }
        });
        return row + "</tr>";
      }).join("");
    }
  </script>
</head>
<body>
  <h1>é ã‚¿ãƒ¡å¤§ä¼š</h1>
  <div class="title-note-wrapper">
    <div class="note-label">
ä¸‹è¨˜é †ç•ªã§å…¥åŠ›ãŠã­ãŒã„ã—ã¾ã™<br>
â‘ ã€Œå‚åŠ è€…æ°åã€ã«ã€åå‰ã‚’å…¥åŠ›ã€€ä¾‹ï¼šå±±ç”°<br>
â‘¡ã€Œå¯¾å±€ãƒãƒ£ãƒƒãƒˆã€ã«ã€ã‚°ãƒ«ãƒ¼ãƒ—åã¨åå‰ã¨81é“å ´IDã‚’å…¥åŠ›ã—ã€Œé€ä¿¡ã€<br>
â‘¢ã€Œå‚åŠ è€…åç°¿ã€ã®ã€Œå‚åŠ è€…è¿½åŠ ã€ã‚’æŠ¼ã—ã€åå‰ã‚’å…¥åŠ›ã€€â€» å¸­ä¸»ãŒçš†ã•ã‚“ã®å…¥åŠ›ã‚’ç¢ºèªã—ã¦ã‹ã‚‰ã€æ‰‹åˆã„ã‚’ã¤ã‘ã¾ã™<br>
â‘£ã€Œå¯¾å±€ä¸€è¦§ã€ã«è‡ªåˆ†ã®åå‰ãŒç¢ºèªå‡ºæ¥ãŸã‚‰ã€æ‰‹åˆã„ãŒã¤ã„ãŸã“ã¨ã«ãªã‚Šã¾ã™ã®ã§ã€ãã®ã€ŒNoã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚å…ˆå¾Œã§ï¼’å±€ã®ãŸã‚ã€åŒã˜ç›¸æ‰‹ã¨ã®å¯¾å±€ãŒï¼’è¡Œã‚ã‚Šã¾ã™ãŒã€ãã®éš›ã®æŠ¼ã™ã€ŒNoã€ã¯å¥‡æ•°ã®æ–¹ã§ã™ã€‚æŠ¼ã—ã¾ã™ã¨ã€ã€Œ2äººäºˆå®šèª¿æ•´ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã€ã¨ã„ã†åˆ¥ã®ãƒšãƒ¼ã‚¸ãŒé–‹ãã¾ã™ã€‚ãã“ã§å¯¾å±€è€…ã¨å¯¾å±€æ—¥ç¨‹ã‚’èª¿æ•´ã—ã€æ„Ÿæƒ³æˆ¦ã¾ã§è¡Œã£ã¦ãã ã•ã„ã€‚<br>
ä»¥ä¸Šã§ã™ã€‚
  </div>
  </div>

  <div class="container">å‚åŠ è€…å: <input type="text" id="nameInput" placeholder="ã‚ãªãŸã®åå‰"></div>
  
  <div class="container">
    <h2>å¯¾å±€ãƒãƒ£ãƒƒãƒˆ</h2>
    <div id="chatMessages"></div>
    <div class="chat-input-area">
      <input type="text" id="chatInput">
      <button id="sendBtn">é€ä¿¡</button>
    </div>
  </div>

  <div class="container">
    <h2>å‚åŠ è€…åç°¿</h2>
    <table class="shogi-table">
      <thead>
        <tr>
          <th class="admin-only col-check">é¸</th>
          <th class="col-no">No</th>
          <th>åå‰</th>
        </tr>
      </thead>
      <tbody id="playerListBody"></tbody>
    </table>
    <button id="addPlayerBtn" class="add-row-btn" style="background-color:#4caf50;">å‚åŠ è€…ã‚’è¿½åŠ </button>
    <button id="delPlayerBtn" class="list-del-btn admin-only">é¸æŠã—ãŸå‚åŠ è€…ã‚’å‰Šé™¤</button>
  </div>

  <div class="container">
    <h2>å¯¾å±€ä¸€è¦§</h2>
    <div class="filter-area">
      <label class="filter-label">ğŸ” è‡ªåˆ†ã®å¯¾å±€ã®ã¿ã‚’è¡¨ç¤ºã™ã‚‹:</label>
      <select id="playerFilter">
        <option value="">-- ã™ã¹ã¦ã®å¯¾å±€ã‚’è¡¨ç¤º --</option>
      </select>
    </div>
    <table class="shogi-table">
      <thead>
        <tr>
          <th class="admin-only col-check">é¸</th>
          <th class="col-no">No</th>
          <th class="col-player">å…ˆæ‰‹ï¼ˆâ–²ï¼‰</th>
          <th class="col-player">å¾Œæ‰‹ï¼ˆâ–³ï¼‰</th>
          <th class="col-result">çµæœ</th>
        </tr>
      </thead>
      <tbody id="shogiBody"></tbody>
    </table>
    <button id="addRowBtn" class="add-row-btn">æ–°ã—ã„å¯¾å±€ã‚’è¿½åŠ </button>
    <button id="lockGameBtn" class="lock-btn admin-only">é¸æŠã—ãŸå¯¾å±€ã®Noã‚’éè¡¨ç¤º/ãƒªãƒ³ã‚¯ç„¡åŠ¹åŒ–</button>
    <button id="listDelBtn" class="list-del-btn admin-only">é¸æŠã—ãŸå¯¾å±€ã‚’å‰Šé™¤</button>
  </div>

  <div class="container">
    <h2>ãƒªãƒ¼ã‚°çµæœè¡¨</h2>
    <div class="matrix-wrapper">
      <table class="matrix-table"><thead id="matrixHeader"></thead><tbody id="matrixBody"></tbody></table>
    </div>
  </div>
  <div class="master-delete-area admin-only">
    <button id="masterDeleteBtn">å…¨ãƒ‡ãƒ¼ã‚¿ä¸€æ‹¬å‰Šé™¤</button>
  </div>
</body>
</html>