<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>遠タメ大会</title>
  <style>
    body {
      font-family: "Yu Gothic", "Meiryo", sans-serif;
      margin: 10px; padding: 0;
      background: #f0f0f0; color: #333; line-height: 1.5;
    }
    h1, h2 { text-align: center; margin-bottom: 15px; color: #5d4037; }
    .container {
      max-width: 850px; margin: 0 auto 20px;
      background: #fff; padding: 15px;
      border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    input[type="text"], select {
      width: 100%; font-size: 1rem; padding: 6px;
      border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box;
    }

    /* チャットエリア */
    #chatMessages {
      height: 150px; margin-bottom: 10px; padding: 10px;
      background: #fafafa; border: 1px solid #eee; border-radius: 4px;
      overflow-y: auto; font-size: 0.95rem;
    }
    .chat-input-area { display: flex; gap: 5px; }
    .chat-input-area input { flex: 1; }

    button {
      padding: 8px 12px; border: none; border-radius: 4px;
      cursor: pointer; color: white; font-weight: bold;
    }
    #sendBtn { background-color: #795548; }
    #chatClearBtn { background-color: #9e9e9e; font-size: 0.85rem; }
    
    .add-row-btn { background-color: #5d4037; width: 100%; margin-top: 15px; }
    .list-del-btn { background-color: #f44336; width: 100%; margin-top: 10px; font-size: 0.85rem; }

    /* マトリクス表 */
    .matrix-wrapper { overflow-x: auto; margin-bottom: 30px; border: 1px solid #d7ccc8; }
    .matrix-table { width: auto; border-collapse: collapse; font-size: 0.85rem; background: #fff; min-width: 100%; }
    .matrix-table th, .matrix-table td {
      border: 1px solid #d7ccc8; padding: 10px; text-align: center; white-space: nowrap;
    }
    #matrixHeader th { background-color: #8d6e63; color: white; }
    .row-label { background-color: #8d6e63 !important; color: white !important; font-weight: bold; }
    .matrix-diagonal { background-color: #e0e0e0; }
    .win-text { color: #d32f2f; font-weight: bold; }
    .lose-text { color: #1976d2; font-weight: bold; }

    /* 各種テーブル共通 */
    .shogi-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    .shogi-table th { background-color: #a1887f; color: white; padding: 8px; font-size: 0.8rem; }
    .shogi-table td { border: 1px solid #d7ccc8; padding: 5px; text-align: center; }
    .player-select { border: none; background: #fff9f0; cursor: pointer; }
    .name-list-input { border: none; border-bottom: 1px dashed #ccc; text-align: center; }

    /* マスター削除 */
    .master-delete-area { max-width: 850px; margin: 40px auto; text-align: center; }
    #masterDeleteBtn { background-color: #d32f2f; width: 100%; padding: 15px; font-size: 1rem; }
  </style>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getDatabase, ref, remove, update, onValue, push } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCx5anv3WWOQyke9kqhhZ9Zx-RjynLuxzE",
      authDomain: "calendar-chousei.firebaseapp.com",
      databaseURL: "https://calendar-chousei-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "calendar-chousei",
      storageBucket: "calendar-chousei.firebasestorage.app",
      messagingSenderId: "368704703397",
      appId: "1:368704703397:web:86ae24d920aaf7c5a0f64c"
  };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const roomName = location.pathname.split('/').pop().replace('.html', '');
    let myUserName = "";
    let globalPlayers = []; // 参加者リストのキャッシュ

    function escapeHtml(str) {
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    document.addEventListener("DOMContentLoaded", () => {
      // ローカルストレージ復元
      const savedName = localStorage.getItem(`${roomName}UserName`);
      if (savedName) { 
        document.getElementById("nameInput").value = savedName;
        myUserName = savedName;
      }
      document.getElementById("nameInput").addEventListener("input", (e) => {
        myUserName = e.target.value.trim();
        localStorage.setItem(`${roomName}UserName`, myUserName);
      });

      // チャット同期
      onValue(ref(db, `${roomName}/chat`), (snap) => {
        const chatMessages = document.getElementById("chatMessages");
        chatMessages.innerHTML = "";
        snap.forEach(c => {
          const m = c.val();
          chatMessages.innerHTML += `<p><strong>${escapeHtml(m.name)}</strong>: ${escapeHtml(m.text)}</p>`;
        });
        chatMessages.scrollTop = chatMessages.scrollHeight;
      });

      document.getElementById("sendBtn").addEventListener("click", () => {
        const text = document.getElementById("chatInput").value.trim();
        if (!myUserName || !text) return;
        push(ref(db, `${roomName}/chat`), { name: myUserName, text, time: Date.now() });
        document.getElementById("chatInput").value = "";
      });

      document.getElementById("chatClearBtn").addEventListener("click", () => {
        if (confirm("チャット履歴を全削除しますか？")) remove(ref(db, `${roomName}/chat`));
      });

      // --- 参加者名簿の同期 ---
      onValue(ref(db, `${roomName}/playerMaster`), (snapshot) => {
        const playerListBody = document.getElementById("playerListBody");
        playerListBody.innerHTML = "";
        globalPlayers = [];
        let index = 1;

        snapshot.forEach((child) => {
          const p = { id: child.key, name: child.val().name || "" };
          globalPlayers.push(p);

          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td><input type="checkbox" class="master-del-check" value="${p.id}"></td>
            <td>${index++}</td>
            <td><input type="text" class="name-list-input" value="${escapeHtml(p.name)}" 
                onchange="updateMasterName('${p.id}', this.value)"></td>
          `;
          playerListBody.appendChild(tr);
        });
        // 名簿が更新されたら対戦表とマトリクスも再描画
        refreshGames();
      });

      window.updateMasterName = (id, val) => update(ref(db, `${roomName}/playerMaster/${id}`), { name: val });
      
      document.getElementById("addPlayerBtn").addEventListener("click", () => {
        push(ref(db, `${roomName}/playerMaster`), { name: "" });
      });

      document.getElementById("delPlayerBtn").addEventListener("click", async () => {
        const checks = document.querySelectorAll(".master-del-check:checked");
        if (checks.length === 0) return;
        if (confirm("選択した参加者を名簿から削除しますか？")) {
          for (const chk of checks) await remove(ref(db, `${roomName}/playerMaster/${chk.value}`));
        }
      });

      // --- 対戦表の同期 ---
      function refreshGames() {
        onValue(ref(db, `${roomName}/shogiGames`), (snapshot) => {
          const shogiBody = document.getElementById("shogiBody");
          shogiBody.innerHTML = "";
          const games = [];
          let index = 1;

          snapshot.forEach((child) => {
            const game = { id: child.key, no: index, ...child.val() };
            games.push(game);

            // プルダウンのオプション生成
            let options = `<option value="">--選択--</option>`;
            globalPlayers.forEach(p => {
              if (!p.name) return;
              options += `<option value="${escapeHtml(p.name)}" ${game.p1===p.name?'selected':''}>${escapeHtml(p.name)}</option>`;
            });
            let options2 = `<option value="">--選択--</option>`;
            globalPlayers.forEach(p => {
              if (!p.name) return;
              options2 += `<option value="${escapeHtml(p.name)}" ${game.p2===p.name?'selected':''}>${escapeHtml(p.name)}</option>`;
            });

            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td><input type="checkbox" class="del-check" value="${game.id}"></td>
              <td>${game.no}</td>
              <td><select class="player-select" onchange="updateGameField('${game.id}', 'p1', this.value)">${options}</select></td>
              <td>vs</td>
              <td><select class="player-select" onchange="updateGameField('${game.id}', 'p2', this.value)">${options2}</select></td>
              <td>
                <select onchange="updateGameField('${game.id}', 'result', this.value)">
                  <option value="-" ${game.result==='-'?'selected':''}>-</option>
                  <option value="○" ${game.result==='○'?'selected':''}>先手勝</option>
                  <option value="×" ${game.result==='×'?'selected':''}>後手勝</option>
                </select>
              </td>
            `;
            shogiBody.appendChild(tr);
            index++;
          });
          renderMatrix(globalPlayers.map(p => p.name).filter(n => n !== "").sort(), games);
        }, { onlyOnce: true });
      }

      window.updateGameField = (id, field, val) => update(ref(db, `${roomName}/shogiGames/${id}`), { [field]: val });

      function renderMatrix(playerList, games) {
        const header = document.getElementById("matrixHeader");
        const body = document.getElementById("matrixBody");
        header.innerHTML = "<tr><th></th>" + playerList.map(p => `<th>${escapeHtml(p)}</th>`).join("") + "</tr>";
        body.innerHTML = "";
        playerList.forEach(rowP => {
          const tr = document.createElement("tr");
          tr.innerHTML = `<td class="row-label">${escapeHtml(rowP)}</td>`;
          playerList.forEach(colP => {
            const td = document.createElement("td");
            if (rowP === colP) td.className = "matrix-diagonal";
            else {
              const matches = games.filter(g => (g.p1 === rowP && g.p2 === colP) || (g.p1 === colP && g.p2 === rowP));
              td.innerHTML = matches.map(g => {
                if (g.result === "-") return null;
                let sym = (g.p1 === rowP) ? (g.result === "○" ? "○" : "×") : (g.result === "○" ? "×" : "○");
                return `<span class="${sym==='○'?'win-text':'lose-text'}">${g.no}:${sym}</span>`;
              }).filter(r => r).join("、");
            }
            tr.appendChild(td);
          });
          body.appendChild(tr);
        });
      }

      document.getElementById("addRowBtn").addEventListener("click", () => push(ref(db, `${roomName}/shogiGames`), { p1: "", p2: "", result: "-" }));
      document.getElementById("listDelBtn").addEventListener("click", async () => {
        const checks = document.querySelectorAll(".del-check:checked");
        if (checks.length > 0 && confirm("選択した対局を削除しますか？")) {
          for (const chk of checks) await remove(ref(db, `${roomName}/shogiGames/${chk.value}`));
        }
      });

      document.getElementById("masterDeleteBtn").addEventListener("click", async () => {
        if (confirm("全てのデータを完全に消去しますか？")) {
          await remove(ref(db, roomName));
          localStorage.removeItem(`${roomName}UserName`);
          location.reload();
        }
      });
    });
  </script>
</head>
<body>

  <h1>遠タメ大会</h1>

  <div class="container">
    <label>チャット入力者名: <input type="text" id="nameInput" placeholder="あなたの名前" /></label>
  </div>

  <div class="container">
    <h2>チャット</h2>
    <div id="chatMessages"></div>
    <div class="chat-input-area">
      <input type="text" id="chatInput" placeholder="メッセージ" />
      <button id="sendBtn">送信</button>
      <button id="chatClearBtn">クリア</button>
    </div>
  </div>

  <div class="container">
    <h2>対戦表</h2>
    <div class="matrix-wrapper">
      <table class="matrix-table">
        <thead id="matrixHeader"></thead>
        <tbody id="matrixBody"></tbody>
      </table>
    </div>

    <table class="shogi-table">
      <thead>
        <tr><th style="width:30px;">選</th><th style="width:30px;">No</th><th>先手（▲）</th><th></th><th>後手（△）</th><th>結果</th></tr>
      </thead>
      <tbody id="shogiBody"></tbody>
    </table>
    <button id="addRowBtn" class="add-row-btn">+ 新しい対局を追加</button>
    <button id="listDelBtn" class="list-del-btn">選択した対局を削除</button>
  </div>

  <div class="container">
    <h2>参加者名簿</h2>
    <table class="shogi-table">
      <thead>
        <tr><th style="width:30px;">選</th><th style="width:30px;">No</th><th>名前（テキスト入力）</th></tr>
      </thead>
      <tbody id="playerListBody"></tbody>
    </table>
    <button id="addPlayerBtn" class="add-row-btn" style="background-color:#4caf50;">+ 参加者を追加</button>
    <button id="delPlayerBtn" class="list-del-btn">選択した参加者を削除</button>
  </div>

  <div class="master-delete-area">
    <button id="masterDeleteBtn">全データ一括削除</button>
  </div>

</body>
</html>
