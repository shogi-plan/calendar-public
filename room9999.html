<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<title>遠タメ将棋 Online</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<style>
/* CSSは元のデザインを継承（一部調整） */
:root{ --ui-font: 14px; --ui-font-lg: 16px; --btn-pad-y: 8px; --btn-pad-x: 12px; }
body{ font-family: system-ui, sans-serif; display:flex; flex-direction:column; align-items:center; padding:10px; background: #f0f0f0; }
h1{ font-size: 1.2rem; margin: 5px; }
#status-badge { background: #333; color: #fff; padding: 4px 12px; border-radius: 20px; margin-bottom: 10px; font-size: 12px; }

#board{
  display:grid; grid-template-columns:repeat(9,1fr); grid-template-rows:repeat(9,1fr);
  border:3px solid #333; width:92vmin; height:92vmin; position:relative;
  transition: transform 0.3s ease; transform-origin: center;
}
#board.flipped{ transform: rotate(180deg); }
.cell{
  display:flex; align-items:center; justify-content:center; cursor:pointer;
  background:#f5deb3; border:0.5px solid #999; font-weight:bold;
  font-size: clamp(14px, 4vmin, 28px); user-select:none; position:relative;
}
.selected{ background:#fff5a6 !important; box-shadow: inset 0 0 0 3px #ffcd00; }
.piece{ line-height:1; }
.piece.promoted{ color:#b30000; }
.piece.opposite{ transform: rotate(180deg); }

#hands{ margin-top:10px; display:flex; gap:10px; width:100%; justify-content: center; }
.hand-block{ width:48%; }
.hand{ min-height:40px; border:1px solid #ccc; background:#fff; display:flex; flex-wrap:wrap; gap:4px; padding:5px; border-radius:4px; }
.hand span{ border:1px solid #aaa; padding:2px 6px; cursor:pointer; border-radius:3px; }
.hand span.selected { background: #ffcd00; }

#controls { display: flex; gap: 5px; margin-bottom: 10px; flex-wrap: wrap; justify-content: center; }
button { padding: 6px 12px; cursor: pointer; border-radius: 4px; border: 1px solid #ccc; }
.hidden { display: none; }
</style>
</head>
<body>

<h1>遠タメ将棋 Online</h1>
<div id="status-badge">接続中...</div>

<div id="controls">
    <button id="resetBtn">盤面リセット</button>
    <button id="flipBtn">盤面反転</button>
    <button id="copyUrl">対局URLをコピー</button>
</div>

<div id="timebar">
  <span>先手: <span id="timerS">--:--</span></span> | 
  <span>後手: <span id="timerG">--:--</span></span>
</div>

<div id="board"></div>

<div id="hands">
  <div class="hand-block">
    <div>先手 持ち駒</div>
    <div id="handS" class="hand"></div>
  </div>
  <div class="hand-block">
    <div>後手 持ち駒</div>
    <div id="handG" class="hand"></div>
  </div>
</div>

<script>
// --- Firebase 設定 ---
const firebaseConfig = {
      apiKey: "AIzaSyCx5anv3WWOQyke9kqhhZ9Zx-RjynLuxzE",
      authDomain: "calendar-chousei.firebaseapp.com",
      databaseURL: "https://calendar-chousei-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "calendar-chousei",
      storageBucket: "calendar-chousei.firebasestorage.app",
      messagingSenderId: "368704703397",
      appId: "1:368704703397:web:86ae24d920aaf7c5a0f64c"
  };
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// --- ルーム設定 ---
const urlParams = new URLSearchParams(window.location.search);
let roomId = urlParams.get('room');
if (!roomId) {
    roomId = Math.random().toString(36).substring(2, 8);
    window.history.pushState({}, '', `?room=${roomId}`);
}
const roomRef = db.collection('rooms').doc(roomId);

// --- 将棋ロジック定数 ---
const PIECE_SYMBOLS={FU:'歩',KY:'香',KE:'桂',GI:'銀',KI:'金',KA:'角',HI:'飛',OU:'玉',TO:'と',NY:'成香',NK:'成桂',NG:'成銀',UM:'馬',RY:'龍'};
const PROMOTABLE=['FU','KY','KE','GI','KA','HI'];

// --- アプリ状態 ---
let state = {
    board: [],
    handS: [],
    handG: [],
    turn: 'S',
    players: { S: null, G: null },
    lastMove: null
};
let myRole = null; // 'S', 'G', or 'watcher'
let selected = null;
let selectedHand = null;

// --- 初期化 ---
function getInitialBoard() {
    const b = Array(9).fill(null).map(() => Array(9).fill(null));
    const setup = (y, side, pieces) => {
        pieces.forEach((p, x) => { if(p) b[y][x] = {type:p, owner:side, initSide: side==='S'?'B':'T'}; });
    };
    setup(0, 'G', ['KY','KE','GI','KI','OU','KI','GI','KE','KY']);
    setup(1, 'G', [null,'HI',null,null,null,null,null,'KA',null]);
    setup(2, 'G', Array(9).fill('FU'));
    setup(6, 'S', Array(9).fill('FU'));
    setup(7, 'S', [null,'KA',null,null,null,null,null,'HI',null]);
    setup(8, 'S', ['KY','KE','GI','KI','OU','KI','GI','KE','KY']);
    return b;
}

// --- Firebase同期処理 ---
async function joinRoom() {
    const doc = await roomRef.get();
    if (!doc.exists) {
        // 最初のプレイヤーが初期化
        const initialState = {
            board: JSON.stringify(getInitialBoard()),
            handS: [], handG: [], turn: 'S',
            playerS: 'user_' + Math.random().toString(16).slice(2),
            playerG: null
        };
        await roomRef.set(initialState);
        myRole = 'S';
    } else {
        const data = doc.data();
        const userId = 'user_' + Math.random().toString(16).slice(2);
        if (!data.playerG && data.playerS !== userId) {
            await roomRef.update({ playerG: userId });
            myRole = 'G';
        } else {
            myRole = (data.playerS === userId) ? 'S' : (data.playerG === userId ? 'G' : 'watcher');
        }
    }
    document.getElementById('status-badge').textContent = `ルーム: ${roomId} / あなた: ${myRole === 'S' ? '先手' : myRole === 'G' ? '後手' : '観戦'}`;
    
    // 自動盤面反転
    if(myRole === 'G') document.getElementById('board').classList.add('flipped');
}

// リアルタイムリスナー
roomRef.onSnapshot(doc => {
    const data = doc.data();
    if(!data) return;
    state.board = JSON.parse(data.board);
    state.handS = data.handS || [];
    state.handG = data.handG || [];
    state.turn = data.turn;
    render();
});

async function saveState() {
    await roomRef.update({
        board: JSON.stringify(state.board),
        handS: state.handS,
        handG: state.handG,
        turn: state.turn === 'S' ? 'G' : 'S'
    });
}

// --- UI描画 ---
function render() {
    const boardEl = document.getElementById('board');
    boardEl.innerHTML = '';
    for(let y=0; y<9; y++) {
        for(let x=0; x<9; x++) {
            const cell = document.createElement('div');
            cell.className = 'cell';
            const p = state.board[y][x];
            if(p) {
                const div = document.createElement('div');
                div.className = `piece ${p.owner !== 'S' ? 'opposite' : ''} ${['TO','NY','NK','NG','UM','RY'].includes(p.type) ? 'promoted' : ''}`;
                div.textContent = PIECE_SYMBOLS[p.type];
                cell.appendChild(div);
            }
            if(selected && selected.x === x && selected.y === y) cell.classList.add('selected');
            cell.onclick = () => handleCellClick(x, y);
            boardEl.appendChild(cell);
        }
    }
    renderHands();
}

function renderHands() {
    const draw = (el, list, owner) => {
        el.innerHTML = '';
        list.forEach((type, i) => {
            const s = document.createElement('span');
            s.textContent = PIECE_SYMBOLS[type];
            if(selectedHand && selectedHand.owner === owner && selectedHand.index === i) s.className = 'selected';
            s.onclick = (e) => {
                e.stopPropagation();
                if(state.turn !== myRole || owner !== myRole) return;
                selectedHand = {type, owner, index: i};
                selected = null;
                render();
            };
            el.appendChild(s);
        });
    };
    draw(document.getElementById('handS'), state.handS, 'S');
    draw(document.getElementById('handG'), state.handG, 'G');
}

// --- 操作ロジック ---
function handleCellClick(x, y) {
    if(state.turn !== myRole) return;

    const p = state.board[y][x];

    // 持ち駒を打つ
    if(selectedHand) {
        if(!p) {
            state.board[y][x] = {type: selectedHand.type, owner: myRole, initSide: myRole==='S'?'B':'T'};
            if(myRole === 'S') state.handS.splice(selectedHand.index, 1);
            else state.handG.splice(selectedHand.index, 1);
            selectedHand = null;
            saveState();
        }
        return;
    }

    // 自分の駒を選択
    if(p && p.owner === myRole) {
        selected = {x, y};
        render();
        return;
    }

    // 移動先を選択
    if(selected) {
        const fromP = state.board[selected.y][selected.x];
        // 成りの判定（簡易版）
        let targetType = fromP.type;
        const isPromotionZone = myRole === 'S' ? (y <= 2 || selected.y <= 2) : (y >= 6 || selected.y >= 6);
        if(PROMOTABLE.includes(targetType) && isPromotionZone) {
            if(confirm("成りますか？")) {
                const promoMap = {FU:'TO', KY:'NY', KE:'NK', GI:'NG', KA:'UM', HI:'RY'};
                targetType = promoMap[targetType];
            }
        }

        // 駒を取る
        if(p) {
            const rawType = unpromote(p.type);
            if(myRole === 'S') state.handS.push(rawType);
            else state.handG.push(rawType);
        }

        state.board[y][x] = {type: targetType, owner: myRole, initSide: fromP.initSide};
        state.board[selected.y][selected.x] = null;
        selected = null;
        saveState();
    }
}

function unpromote(type){
    const map = {TO:'FU', NY:'KY', NK:'KE', NG:'GI', UM:'KA', RY:'HI'};
    return map[type] || type;
}

// --- イベント ---
document.getElementById('resetBtn').onclick = async () => {
    if(!confirm("盤面を初期化しますか？")) return;
    await roomRef.update({
        board: JSON.stringify(getInitialBoard()),
        handS: [], handG: [], turn: 'S'
    });
};

document.getElementById('flipBtn').onclick = () => {
    document.getElementById('board').classList.toggle('flipped');
};

document.getElementById('copyUrl').onclick = () => {
    navigator.clipboard.writeText(window.location.href);
    alert("対局URLをコピーしました。相手に送ってください。");
};

// 起動
joinRoom();

</script>
</body>
</html>
