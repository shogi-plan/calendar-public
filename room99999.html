<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>遠タメ将棋 Online</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    :root { --ui-font: 14px; }
    body { font-family: "Yu Gothic", sans-serif; display: flex; flex-direction: column; align-items: center; background: #f0f0f0; padding: 10px; margin: 0; }
    h1 { font-size: 1.2rem; color: #5d4037; margin: 10px 0; }
    #status-badge { background: #795548; color: #fff; padding: 4px 12px; border-radius: 20px; margin-bottom: 10px; font-size: 12px; }
    
    /* 盤面 */
    #board { display: grid; grid-template-columns: repeat(9,1fr); grid-template-rows: repeat(9,1fr); border: 2px solid #333; width: 92vmin; height: 92vmin; background: #f5deb3; position: relative; }
    .cell { display: flex; align-items: center; justify-content: center; border: 0.5px solid #999; font-size: clamp(16px, 4vmin, 30px); cursor: pointer; font-weight: bold; }
    .selected { background: #fff5a6; outline: 2px solid orange; z-index: 5; }
    .piece.opposite { transform: rotate(180deg); }
    .piece.promoted { color: #d32f2f; }

    /* UIエリア */
    .controls { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; margin-bottom: 10px; max-width: 500px; }
    button { padding: 8px 12px; border: none; border-radius: 4px; cursor: pointer; color: white; font-weight: bold; background: #8d6e63; }
    button:hover { background: #5d4037; }
    select, input { padding: 5px; border-radius: 4px; border: 1px solid #ccc; }

    /* 駒台 */
    #hands { display: flex; justify-content: space-around; width: 100%; margin: 10px 0; max-width: 500px; }
    .hand-block { width: 45%; text-align: center; font-size: 12px; }
    .hand { min-height: 40px; border: 1px solid #d7ccc8; background: #fff; padding: 5px; display: flex; gap: 5px; border-radius: 5px; flex-wrap: wrap; margin-top: 4px; }
    .hand span { border: 1px solid #aaa; padding: 2px 6px; border-radius: 3px; cursor: pointer; background: #eee; }
    .hand span.selected { background: #ffea00; border-color: orange; }

    /* 棋譜 */
    #kifuList { height: 100px; overflow-y: auto; background: #fff; width: 92vmin; max-width: 500px; border: 1px solid #d7ccc8; list-style: none; padding: 5px; font-size: 12px; margin: 10px 0; }
    .kifu-item { padding: 2px 5px; border-bottom: 1px solid #eee; cursor: pointer; }
    .kifu-selected { background: #d1e9ff; }
    .hidden { display: none !important; }
  </style>
</head>
<body>

<h1>遠タメ将棋 Online</h1>
<div id="status-badge">接続中...</div>

<div class="controls">
  <label>自分: <select id="mySideSelect"><option value="S">先手</option><option value="G">後手</option></select></label>
  <button id="btnReset" style="background:#d32f2f;">同期初期化</button>
  <button id="btnFlip">盤面反転</button>
  <button id="btnKanso">感想戦モード</button>
  <button id="btnCopy">棋譜コピー</button>
</div>

<div id="board"></div>

<div id="kanso-ui" class="controls hidden" style="margin-top:10px;">
  <button id="btnPrev">← 一手戻る</button>
  <button id="btnNext">一手進む →</button>
</div>

<div id="hands">
  <div class="hand-block">先手 持ち駒<div class="hand" id="handS"></div></div>
  <div class="hand-block">後手 持ち駒<div class="hand" id="handG"></div></div>
</div>

<ul id="kifuList" class="hidden"></ul>

<script type="module">
  // 待合室コードと同じ import スタイルを採用
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
  import { getDatabase, ref, set, onValue, update } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

  const firebaseConfig = {
      apiKey: "AIzaSyCx5anv3WWOQyke9kqhhZ9Zx-RjynLuxzE",
      authDomain: "calendar-chousei.firebaseapp.com",
      databaseURL: "https://calendar-chousei-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "calendar-chousei",
      storageBucket: "calendar-chousei.firebasestorage.app",
      messagingSenderId: "368704703397",
      appId: "1:368704703397:web:86ae24d920aaf7c5a0f64c"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  // ルーム名は待合室と同じロジック（ファイル名など）で固定
  const roomName = location.pathname.split('/').pop().replace('.html', '') || "default_room";
  const gameRef = ref(db, `${roomName}/shogiData`);

  // --- 定数 ---
  const SYMBOLS = {FU:'歩',KY:'香',KE:'桂',GI:'銀',KI:'金',KA:'角',HI:'飛',OU:'玉',TO:'と',NY:'成香',NK:'成桂',NG:'成銀',UM:'馬',RY:'龍'};
  const PROMOTABLES = ['FU','KY','KE','GI','KA','HI'];

  // --- 状態 ---
  let state = { board: [], handS: [], handG: [], turn: 'S', kifu: [], history: [], hIdx: 0 };
  let mySide = 'S';
  let isKanso = false;
  let sel = null;
  let selH = null;

  // --- Firebase 監視 ---
  onValue(gameRef, (snapshot) => {
    const data = snapshot.val();
    if (!data) {
      document.getElementById('status-badge').textContent = "盤面未作成：初期化してください";
      return;
    }
    // データの復元
    state = {
      ...data,
      board: JSON.parse(data.board),
      history: JSON.parse(data.history),
      handS: data.handS || [],
      handG: data.handG || [],
      kifu: data.kifu || []
    };
    document.getElementById('status-badge').textContent = `対局中（あなた: ${mySide==='S'?'先手':'後手'} / 手番: ${state.turn==='S'?'先手':'後手'}）`;
    render();
  });

  async function sync() {
    await set(gameRef, {
      ...state,
      board: JSON.stringify(state.board),
      history: JSON.stringify(state.history)
    });
  }

  // --- 将棋ロジック ---
  function resetGame() {
    if (!confirm("現在の対局をリセットして初期状態にしますか？")) return;
    const b = Array(9).fill(null).map(()=>Array(9).fill(null));
    const setup = (y,o,ps) => ps.forEach((p,x)=>{if(p)b[y][x]={type:p,owner:o}});
    setup(0,'G',['KY','KE','GI','KI','OU','KI','GI','KE','KY']);
    setup(1,'G',[null,'KA',null,null,null,null,null,'HI',null]);
    setup(2,'G',Array(9).fill('FU'));
    setup(6,'S',Array(9).fill('FU'));
    setup(7,'S',[null,'HI',null,null,null,null,null,'KA',null]);
    setup(8,'S',['KY','KE','GI','KI','OU','KI','GI','KE','KY']);
    
    state = {
      board: b, handS: [], handG: [], turn: 'S', kifu: [],
      history: [{board: b, handS: [], handG: []}],
      hIdx: 0
    };
    sync();
  }

  function handleCellClick(x, y) {
    if (isKanso || state.turn !== mySide) return;
    const p = state.board[y][x];

    if (selH) {
      if (!p) {
        state.board[y][x] = {type: selH.type, owner: mySide};
        if (mySide === 'S') state.handS.splice(selH.idx, 1); else state.handG.splice(selH.idx, 1);
        finishMove(`打${9-x}${y+1}${SYMBOLS[selH.type]}`);
      }
      selH = null; render(); return;
    }

    if (p && p.owner === mySide) {
      sel = {x, y}; render();
    } else if (sel) {
      const fromP = state.board[sel.y][sel.x];
      if (p) {
        const unp = (t) => ({TO:'FU',NY:'KY',NK:'KE',NG:'GI',UM:'KA',RY:'HI'}[t]||t);
        if (mySide === 'S') state.handS.push(unp(p.type)); else state.handG.push(unp(p.type));
      }
      let type = fromP.type;
      const isPZone = (o,y) => o==='S'?y<=2:y>=6;
      if (PROMOTABLES.includes(type) && (isPZone(mySide,y) || isPZone(mySide,sel.y))) {
        if (confirm("成りますか？")) type = {FU:'TO',KY:'NY',KE:'NK',GI:'NG',KA:'UM',HI:'RY'}[type];
      }
      state.board[y][x] = {type, owner: mySide};
      state.board[sel.y][sel.x] = null;
      finishMove(`${9-x}${y+1}${SYMBOLS[type]}`);
      sel = null;
    }
  }

  function finishMove(moveText) {
    state.kifu.push(moveText);
    state.turn = state.turn === 'S' ? 'G' : 'S';
    state.history.push({
      board: JSON.parse(JSON.stringify(state.board)), 
      handS: [...state.handS], 
      handG: [...state.handG]
    });
    state.hIdx = state.history.length - 1;
    sync();
  }

  // --- 描画系 ---
  function render() {
    const boardEl = document.getElementById('board'); boardEl.innerHTML = '';
    state.board.forEach((row, y) => {
      row.forEach((p, x) => {
        const c = document.createElement('div');
        c.className = 'cell' + (sel && sel.x===x && sel.y===y ? ' selected' : '');
        if (p) {
          const d = document.createElement('div');
          d.className = `piece ${p.owner!=='S'?'opposite':''} ${['TO','NY','NK','NG','UM','RY'].includes(p.type)?'promoted':''}`;
          d.textContent = SYMBOLS[p.type];
          c.appendChild(d);
        }
        c.onclick = () => handleCellClick(x, y);
        boardEl.appendChild(c);
      });
    });

    const drawHand = (id, list, owner) => {
      const el = document.getElementById(id); el.innerHTML = '';
      list.forEach((t, i) => {
        const s = document.createElement('span'); s.textContent = SYMBOLS[t];
        if(selH && selH.owner===owner && selH.idx===i) s.className='selected';
        s.onclick = (e) => {
          e.stopPropagation();
          if(state.turn===mySide && owner===mySide && !isKanso) { selH={type:t,owner,idx:i}; sel=null; render(); }
        };
        el.appendChild(s);
      });
    };
    drawHand('handS', state.handS, 'S'); drawHand('handG', state.handG, 'G');

    const kList = document.getElementById('kifuList'); kList.innerHTML = '';
    state.kifu.forEach((m, i) => {
      const li = document.createElement('li');
      li.className = 'kifu-item' + (i+1 === state.hIdx ? ' kifu-selected' : '');
      li.textContent = `${i+1}. ${m}`;
      li.onclick = () => { if(isKanso) jump(i+1); };
      kList.appendChild(li);
    });
  }

  function jump(idx) {
    state.hIdx = idx;
    const h = state.history[idx];
    state.board = JSON.parse(JSON.stringify(h.board));
    state.handS = [...h.handS]; state.handG = [...h.handG];
    render();
  }

  // --- イベント ---
  document.getElementById('btnReset').onclick = resetGame;
  document.getElementById('mySideSelect').onchange = (e) => { 
    mySide = e.target.value; 
    document.getElementById('board').style.transform = (mySide==='G')?'rotate(180deg)':'rotate(0deg)';
    render(); 
  };
  document.getElementById('btnFlip').onclick = () => {
    const b = document.getElementById('board');
    b.style.transform = (b.style.transform==='rotate(180deg)')?'rotate(0deg)':'rotate(180deg)';
  };
  document.getElementById('btnKanso').onclick = () => {
    isKanso = !isKanso;
    document.getElementById('kanso-ui').classList.toggle('hidden');
    document.getElementById('kifuList').classList.toggle('hidden');
    document.getElementById('btnKanso').textContent = isKanso ? "対局に戻る" : "感想戦モード";
  };
  document.getElementById('btnPrev').onclick = () => { if(state.hIdx > 0) jump(state.hIdx - 1); };
  document.getElementById('btnNext').onclick = () => { if(state.hIdx < state.history.length - 1) jump(state.hIdx + 1); };
  document.getElementById('btnCopy').onclick = () => {
    const txt = state.kifu.map((m, i) => `${i+1}.${m}`).join(' ');
    navigator.clipboard.writeText(txt);
    alert("棋譜をコピーしました。");
  };

</script>
</body>
</html>
