<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>本格同期将棋 - Library Edition</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="./shogiboard.css">
  <style>
    body { font-family: sans-serif; background: #e0e0e0; display: flex; flex-direction: column; align-items: center; padding: 10px; margin: 0; }
    .info-bar { background: #fff; padding: 10px; border-radius: 8px; width: 360px; margin-bottom: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
    .timer-display { display: flex; justify-content: space-between; font-size: 24px; font-weight: bold; margin-bottom: 10px; }
    .active-timer { color: #d32f2f; background: #fff9c4; border-radius: 4px; padding: 0 5px; }
    #board-area { width: 360px; height: 400px; background: #f5deb3; position: relative; border: 2px solid #333; }
    /* 簡易盤面描画用 */
    .grid { display: grid; grid-template-columns: repeat(9, 1fr); width: 360px; height: 360px; }
    .cell { border: 0.5px solid #999; display: flex; align-items: center; justify-content: center; font-size: 20px; cursor: pointer; }
    .cell.last-move { background: rgba(255, 200, 0, 0.4); }
    .piece.gote { transform: rotate(180deg); color: #000; }
    .controls { margin-top: 10px; display: flex; gap: 5px; }
    button { padding: 8px 12px; cursor: pointer; border-radius: 4px; border: 1px solid #999; }
    .selected { background: #ffeb3b !important; }
  </style>
</head>
<body>

<div class="info-bar">
  <div class="timer-display">
    <div id="tG">△ 10:00</div>
    <div id="tS">▲ 10:00</div>
  </div>
  <div id="setup">
    持ち時間:<input type="number" id="m" value="10" style="width:30px">分 
    秒読み:<input type="number" id="b" value="30" style="width:30px">秒
    <button id="startBtn">対局開始</button>
  </div>
  <div id="seats" style="margin-top:5px">
    <button id="sitS">▲先手に着席</button>
    <button id="sitG">△後手に着席</button>
    <span id="myRoleDisplay">（観戦中）</span>
  </div>
</div>

<div id="board-area">
  <div id="grid" class="grid"></div>
</div>

<div id="msg" style="color:red; font-weight:bold; margin-top:10px;"></div>

<div class="controls" id="kansoArea" style="display:none">
  <button id="prevBtn">←前</button>
  <button id="nextBtn">次→</button>
  <button id="resetBtn">新規対局へ</button>
</div>

<script src="./shogi.js"></script>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
  import { getDatabase, ref, set, onValue, update, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

  const firebaseConfig = {
      apiKey: "AIzaSyCx5anv3WWOQyke9kqhhZ9Zx-RjynLuxzE",
      authDomain: "calendar-chousei.firebaseapp.com",
      databaseURL: "https://calendar-chousei-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "calendar-chousei",
      storageBucket: "calendar-chousei.firebasestorage.app",
      messagingSenderId: "368704703397",
      appId: "1:368704703397:web:86ae24d920aaf7c5a0f64c"
  };
  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const gameRef = ref(db, "shogi_v5_room");

  const uid = localStorage.getItem("shogi_uid") || Math.random().toString(36).slice(2);
  localStorage.setItem("shogi_uid", uid);

  let shogi = new Shogi();
  let localState = {};
  let selectedPos = null;

  // --- 盤面描画 ---
  function draw() {
    const grid = document.getElementById("grid");
    grid.innerHTML = "";
    for (let y = 1; y <= 9; y++) {
      for (let x = 9; x >= 1; x--) {
        const cell = document.createElement("div");
        cell.className = "cell";
        if (selectedPos && selectedPos.x === x && selectedPos.y === y) cell.classList.add("selected");
        
        const p = shogi.get(x, y);
        if (p) {
          const span = document.createElement("span");
          span.className = "piece " + (p.color === 1 ? "gote" : "sente");
          span.innerText = p.kind;
          cell.appendChild(span);
        }
        cell.onclick = () => onClickCell(x, y);
        grid.appendChild(cell);
      }
    }
  }

  // --- 操作ロジック (A: shogi.jsを利用) ---
  function onClickCell(x, y) {
    const turnColor = shogi.turn; // 0:sente, 1:gote
    const mySide = localState.seats?.S === uid ? 0 : (localState.seats?.G === uid ? 1 : null);
    
    if (mySide !== turnColor) return; // 自分の手番でなければ無視

    if (!selectedPos) {
      const p = shogi.get(x, y);
      if (p && p.color === turnColor) selectedPos = {x, y};
    } else {
      try {
        // shogi.jsの審判機能を利用
        shogi.move(selectedPos.x, selectedPos.y, x, y, false); 
        // 成功したらFirebase更新
        updateFirebase();
      } catch (e) {
        document.getElementById("msg").innerText = "反則: " + e.message;
        setTimeout(() => document.getElementById("msg").innerText = "", 2000);
      }
      selectedPos = null;
    }
    draw();
  }

  async function updateFirebase() {
    const nextSfen = shogi.toSFEN();
    const history = localState.history || [];
    history.push(nextSfen);

    // 千日手チェック (4回重複)
    const sennichite = history.filter(s => s === nextSfen).length >= 4;

    await update(gameRef, {
      sfen: nextSfen,
      history: history,
      lastMoveAt: serverTimestamp(),
      status: sennichite ? "draw" : "playing"
    });
  }

  // --- 同期とタイマー ---
  onValue(gameRef, (snap) => {
    const data = snap.val();
    if (!data) return;
    localState = data;
    shogi.initializeFromSFEN(data.sfen);
    
    document.getElementById("myRoleDisplay").innerText = 
      data.seats?.S === uid ? "▲先手" : (data.seats?.G === uid ? "△後手" : "（観戦中）");
    
    if (data.status === "draw") document.getElementById("msg").innerText = "千日手引き分け";
    draw();
  });

  // 対局開始ボタン
  document.getElementById("startBtn").onclick = () => {
    const m = document.getElementById("m").value * 60;
    set(gameRef, {
      sfen: "lnsgkgsln/1r5b1/ppppppppp/9/9/9/PPPPPPPPP/1B5R1/LNSGKGSLN b - 1",
      seats: {S: null, G: null},
      history: [],
      timeLeftS: m,
      timeLeftG: m,
      byo: document.getElementById("b").value,
      status: "playing",
      lastMoveAt: serverTimestamp()
    });
  };

  // 席取り
  document.getElementById("sitS").onclick = () => update(ref(db, "shogi_v5_room/seats"), {S: uid});
  document.getElementById("sitG").onclick = () => update(ref(db, "shogi_v5_room/seats"), {G: uid});

</script>
</body>
</html>
