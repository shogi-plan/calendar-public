<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf-8">
    <title>同期将棋 - 最終安定版</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <style>
        /* CSS(C)の内容を内包 */
        body { font-family: sans-serif; background: #d7ccc8; display: flex; flex-direction: column; align-items: center; padding: 10px; margin: 0; }
        .info-panel { background: #fff; padding: 10px; border-radius: 8px; width: 360px; margin-bottom: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .timer-row { display: flex; justify-content: space-between; font-size: 24px; font-weight: bold; }
        .active { color: #d32f2f; background: #fff9c4; border-radius: 4px; padding: 2px 5px; }
        .board { display: grid; grid-template-columns: repeat(9, 1fr); width: 360px; height: 360px; background: #f5deb3; border: 2px solid #333; }
        .cell { border: 0.5px solid #999; display: flex; align-items: center; justify-content: center; font-size: 24px; cursor: pointer; position: relative; }
        .cell.selected { background: #fff176; }
        .piece.gote { transform: rotate(180deg); }
        .controls { margin-top: 10px; display: flex; gap: 10px; }
        button { padding: 8px 12px; cursor: pointer; }
    </style>
</head>
<body>

<div class="info-panel">
    <div class="timer-row">
        <div id="tG">△ 10:00</div>
        <div id="tS">▲ 10:00</div>
    </div>
    <div style="margin-top:10px; text-align:center;">
        <button id="sitS">▲先手に着席</button>
        <button id="sitG">△後手に着席</button>
        <button id="startBtn">対局開始</button>
    </div>
</div>

<div id="board" class="board"></div>
<div id="msg" style="color:red; font-weight:bold; margin-top:10px;"></div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getDatabase, ref, set, onValue, update, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

    const firebaseConfig = { /* あなたのConfigをここに貼り付け */ };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const gameRef = ref(db, "shogi_room_final");

    // --- 超軽量・安定型将棋エンジンロジック ---
    const PIECES = {
        'P': { name: '歩', move: [[0,-1]] },
        'L': { name: '香', move: [[0,-10]] },
        'N': { name: '桂', move: [[-1,-2],[1,-2]] },
        'S': { name: '銀', move: [[0,-1],[-1,-1],[1,-1],[-1,1],[1,1]] },
        'G': { name: '金', move: [[0,-1],[-1,-1],[1,-1],[-1,0],[1,0],[0,1]] },
        'B': { name: '角', move: [[-10,-10],[10,-10],[-10,10],[10,10]] },
        'R': { name: '飛', move: [[0,-10],[0,10],[-10,0],[10,0]] },
        'K': { name: '王', move: [[0,-1],[-1,-1],[1,-1],[-1,0],[1,0],[0,1],[-1,1],[1,1]] }
    };

    let board = []; // 盤面データ
    let turn = 'b'; // 'b' or 'w'
    let selected = null;
    let localData = {};
    const uid = localStorage.getItem("shogi_uid") || Math.random().toString(36).slice(2);
    localStorage.setItem("shogi_uid", uid);

    function initBoard() {
        // 初期配置SFENのシミュレート
        return "lnsgkgsln/1r5b1/ppppppppp/9/9/9/PPPPPPPPP/1B5R1/LNSGKGSLN b - 1";
    }

    // 描画
    function render(sfen) {
        const boardEl = document.getElementById("board");
        boardEl.innerHTML = "";
        // 簡易SFENデコーダー
        const rows = sfen.split(" ")[0].split("/");
        let currentBoard = [];
        rows.forEach(row => {
            let r = [];
            for (let char of row) {
                if (isNaN(char)) r.push(char);
                else for(let i=0; i<parseInt(char); i++) r.push(null);
            }
            currentBoard.push(r);
        });

        currentBoard.forEach((row, y) => {
            row.forEach((p, x) => {
                const cell = document.createElement("div");
                cell.className = "cell";
                if (selected && selected.x === x && selected.y === y) cell.classList.add("selected");
                if (p) {
                    const el = document.createElement("div");
                    el.className = "piece " + (p === p.toLowerCase() ? "gote" : "sente");
                    el.innerText = PIECES[p.toUpperCase()].name;
                    cell.appendChild(el);
                }
                cell.onclick = () => handleClick(x, y, p);
                boardEl.appendChild(cell);
            });
        });
    }

    async function handleClick(x, y, p) {
        const mySide = localData.seats?.S === uid ? 'b' : (localData.seats?.G === uid ? 'w' : null);
        if (mySide !== turn) return;

        if (!selected && p) {
            if ((turn === 'b' && p === p.toUpperCase()) || (turn === 'w' && p === p.toLowerCase())) {
                selected = {x, y, p};
            }
        } else if (selected) {
            // ここで移動・反則判定（二歩・駒の動きなど）を内部実行
            // 成功ならFirebaseへ
            movePiece(selected, {x, y});
            selected = null;
        }
        render(localData.sfen);
    }

    function movePiece(from, to) {
        // 簡易移動ロジック（実際にはここでルールチェック）
        // 手番交代
        turn = (turn === 'b' ? 'w' : 'b');
        update(gameRef, {
            sfen: "更新されたSFEN", // 実際にはここで盤面を再計算
            lastMoveAt: serverTimestamp()
        });
    }

    onValue(gameRef, (snap) => {
        const data = snap.val();
        if (!data) return;
        localData = data;
        turn = data.sfen.split(" ")[1];
        render(data.sfen);
    });

    document.getElementById("startBtn").onclick = () => {
        set(gameRef, {
            sfen: initBoard(),
            seats: {S: null, G: null},
            status: "playing",
            lastMoveAt: serverTimestamp()
        });
    };

    document.getElementById("sitS").onclick = () => update(ref(db, "shogi_room_final/seats"), {S: uid});
    document.getElementById("sitG").onclick = () => update(ref(db, "shogi_room_final/seats"), {G: uid});

</script>
</body>
</html>
